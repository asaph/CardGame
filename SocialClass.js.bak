var initialize = function(){
   new CardGame();
}

var CardGame = function(){
   this.players = [];
   var this_ptr = this;
   this.deck = new createDeck();   

   // Attach shuffle handler
   $("#shuffle").click({this: this_ptr}, function(e){
      e.data.this.shuffleCards();
      var cards = e.data.this.deck.cards;
      console.log("len: "+cards.length);
      for(var i = 0; i < cards.length; i++){
         console.log(i+": "+cards[i].value+cards[i].suit+",");
      }
   });

   // Attach deal cards handler
   $("#dealCards").click({this: this_ptr}, function(e){
      e.data.this.dealCards();
      var players = e.data.this.players;
      for(var i = 0; i < players.length; i++){
         console.log(players[i].name.innerHTML);
         for(var j = 0; j < players[i].hand.length; j++){
            console.log("hand: "+players[i].hand[j].value+players[i].hand[j].suit+","+players[i].hand[j].image);
         }
      } 
   });

   // Attach add player to enter key
   $("#inputName").keypress({this: this_ptr}, function(e){
      if(e.keyCode == 13){
         e.preventDefault();
         var name = $("#inputName").val();
         if(name != ""){
            if(e.data.this.players.length == 0){
               e.data.this.players.push(new Player(name,true));
            }else{
               e.data.this.players.push(new Player(name,false));
            }
         }
         $("#inputName").val("");
      }
   });

   // Attach add player button handler
   $("#addPlayer").click({this: this_ptr}, function(e) {
      var name = $("#inputName").val();
      if(e.data.this.players.length == 0){
         e.data.this.players.push(new Player(name,true));
      }else{
         e.data.this.players.push(new Player(name,false));
      }
      $("#inputName").val("");
   });

   // Attach next round button handler
   $("#NextRound").click({this: this_ptr}, function(e) {
      var results = $("#GameResults").val().split(',');
      e.data.this.nextDealer(results);
      $("#GameResults").val("");
   });
}

CardGame.prototype.shuffleCards = function(){
   var i = this.deck.cards.length, j, tempi, tempj;
   if(i == 0) return false;
   while(--i){
      j = Math.floor(Math.random() * (i+1));
      tempi = this.deck.cards[i];
      tempj = this.deck.cards[j];
      this.deck.cards[i] = tempj;
      this.deck.cards[j] = tempi;
   }
}

CardGame.prototype.dealCards = function(){
   var j = 0;
   for(var i = 0; i < this.deck.cards.length; i++){
      if(j == this.players.length){
         j = 0;
      }
      this.players[j].hand.push(this.deck.cards[i]);
      // display cards
      var card = document.createElement("img");
      card.className = "CardImage";
      card.src = "PNG_Cards/"+this.deck.cards[i].image;
      this.players[j].cards.appendChild(card);
      j++;
   }
}

CardGame.prototype.nextDealer = function(results){
   var dealerSet = false;
   for(var i = 0; i < this.players.length; i++){
      // Assign dealer
      if(this.players[i].dealer && !dealerSet){
            this.players[i].dealer = false;
            this.players[i].deal.innerHTML = "";
            this.players[i].deal.className = "dealer";
         if(i+1 < this.players.length){
            this.players[i+1].dealer = true;
            this.players[i+1].deal.innerHTML = "D";  
            this.players[i+1].deal.className = "dealer Show";
         }else{
            this.players[0].dealer = true;
            this.players[0].deal.innerHTML = "D";
            this.players[0].deal.className = "dealer Show";
         }
         dealerSet = true;
      }
      // Assign Status
      if(results[i] == 'M'){
         this.players[i].stat.innerHTML = "";
         this.players[i].className = "";
      }else{
         this.players[i].stat.innerHTML = results[i];
      }

      if(results[i] == 'P'){
         this.players[i].stat.className = "status Pres";
      }else if(results[i] == 'VP'){
         this.players[i].stat.className = "status vicePres";
      }else if(results[i] == 'VA'){
         this.players[i].stat.className = "status viceScum";
      }else if(results[i] == 'A'){
         this.players[i].stat.className = "status Scum";
      }else{
         this.players[i].stat.className = "status";
      }

   }
}

var Player = function(name,isDealer){
   this.dealer = false;
   this.hand = [];

   var cardPlayer = document.createElement("div");
   cardPlayer.className = "cardPlayer";
   var playerName = document.createElement("div");
   playerName.className = "playerName";
   playerName.innerHTML = name;
   var playerStatus = document.createElement("div");
   playerStatus.className = "status";
   var playerDealer = document.createElement("div");
   if(isDealer){
      playerDealer.className = "dealer Show";
      playerDealer.innerHTML = "D";
      this.dealer = true;
   }else{
      playerDealer.className = "dealer";
   }

   var handContainer = document.createElement("div");
   handContainer.className = "hand";

   this.name = playerName;
   this.stat = playerStatus;
   this.deal = playerDealer;
   this.cards = handContainer;

   cardPlayer.appendChild(playerName);
   cardPlayer.appendChild(playerStatus);
   cardPlayer.appendChild(playerDealer);
   cardPlayer.appendChild(handContainer);

   var playContainer = document.getElementById("PlayersContainer");
   playContainer.appendChild(cardPlayer);
}

var createDeck = function(){
   var cardValues = ['3','4','5','6','7','8','9','10','11','12','13','14','15'];
   var cardSuits = ['clubs','diamonds','hearts','spades'];
   this.cards = [];
   for(var i = 0; i < cardValues.length; i++){
      for(var j = 0; j < cardSuits.length; j++){
         this.cards.push(new card(cardValues[i], cardSuits[j]));
      }
   }
}

var card = function(val, suit){
   this.value = val;
   this.suit = suit;
   this.image = ""+val+"_of_"+suit+".png";
}

$(document).ready(initialize);
